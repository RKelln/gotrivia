<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bauman & Scholtz Trivia!</title>

  <link href="public/css/reset.css" rel="stylesheet">
  <link href="public/css/embla.css" rel="stylesheet">
  <link href="public/css/trivia.css" rel="stylesheet">

  <style>
    .embla {
      overflow: hidden;
    }
    .embla__container {
      display: flex;
    }
    .embla__slide {
      position: relative;
      min-width: 100%;
    }
    .embla__slide__img {
      position: relative;
      max-width: 100%;
      max-height: 900px;
    }
    .answered button, .answered input {
      opacity: 0.5;
    }
    .answered .selected {
      opacity: 1.0;
      background: yellow;
    }
  </style>
</head>
<body>

    <!-- Embla -->
    <div class="embla">
      <div class="embla__viewport">
        <div class="embla__container">
          <!-- created by javascrript -->
        </div>
      </div>
    </div>


  <script src="https://unpkg.com/embla-carousel@latest/embla-carousel.umd.js"></script>

  <script type="javascript" src="public/js/trivia.js"></script>

  <script>
    const wrap = document.querySelector(".embla");
    const viewPort = wrap.querySelector(".embla__viewport");
    const slideContainer = viewPort.querySelector(".embla__container");

    const createSlidesFromJSON = (jsonData, container) => {
      let html = '';

      if (!jsonData.hasOwnProperty('slides') || jsonData.slides == null) {
        console.log("No slide data in js");
        return;
      }

      jsonData.slides.forEach((slide, s) => {
        html += `
        <div class="embla__slide">
          <div class="embla__slide__inner">
            <img 
              class="embla__slide__img" 
              src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D"
              data-src="public/images/${slide.image}" />`;

        if (slide.hasOwnProperty('question') && slide.hasOwnProperty('answers')) {
          html += `
                <form class="question" method="post" action="answer/${s}">
                  <fieldset>
                    <legend>${slide.question}</legend>
                    <ol>`;

          slide.answers.forEach((answer, a) => {
            let name = `s${s + 1}a${a + 1}`;
            html += `
                      <li>
                        <button name="answer" id="${name}" value="${a}">
                          ${answer}
                        </buttton>
                      </li>`;            
          });

          html += `
                  </ol>
                </fieldset>
              </form>`;
        }
        html += `
          </div>
        </div>
        `;
      });
      //console.log(html);
      container.innerHTML = html;

      // set up buttons
      container.querySelectorAll('button, input').forEach(
        button => button.addEventListener("click", event => {
          button.classList.add("selected");

        })
      );

      // set up all the forms
      container.querySelectorAll("form.question").forEach(
        form => {
          form.addEventListener("submit", event => {
            event.preventDefault();
            console.log("submit form", form);

            let formData = new FormData(form);
            formData.append('player', 'player1');

            const inputs = form.querySelectorAll('button, input');
            inputs.forEach(input => { input.disabled = true; });

            fetch(form.action, {
              method: form.method,
              body: formData
            })
              .then(response => {
                if (response.ok) {
                  return Promise.resolve(response);
                }
                else {
                  return Promise.reject(new Error('Failed to load')); 
                }
              })
              .then(data => {
                console.log(data);
                // success
                form.classList.add("answered");
              })
              .catch((error) => {
                console.error('Error:', error);
                inputs.forEach(input => { input.disabled = false; });
              });
            return false;
          })
        }
      );
      console.log("forms", container.querySelectorAll("form"));
    };

    const lazyLoad = embla => {
      const slides = embla.slideNodes();
      const images = slides.map(slide => slide.querySelector(".embla__slide__img"));
      console.log(images);
      const imagesInView = [];

      const addImageLoadEvent = (image, callback) => {
        image.addEventListener("load", callback);
        return () => image.removeEventListener("load", callback);
      };

      const loadImagesInView = () => {
        embla
          .slidesInView(true)
          .filter(index => imagesInView.indexOf(index) === -1)
          .forEach(loadImageInView);
      };

      const loadImageInView = index => {
        const image = images[index];
        const slide = slides[index];
        imagesInView.push(index);
        image.src = image.getAttribute("data-src");

        const removeImageLoadEvent = addImageLoadEvent(image, () => {
          slide.classList.add("has-loaded");
          removeImageLoadEvent();
        });
      };

      return () => {
        loadImagesInView();
        return imagesInView.length === images.length;
      };
    };

    const initSlides = data => {
      createSlidesFromJSON(data, slideContainer);
      const embla = EmblaCarousel(viewPort);
      const loadImagesInView = lazyLoad(embla);
      const loadImagesInViewAndDestroyIfDone = eventName => {
        const loadedAll = loadImagesInView();
        if (loadedAll) embla.off(eventName, loadImagesInViewAndDestroyIfDone);
      };

      embla.on("init", loadImagesInViewAndDestroyIfDone);
      embla.on("select", loadImagesInViewAndDestroyIfDone);
      embla.on("resize", loadImagesInViewAndDestroyIfDone);
    }

    fetch('slides')
      .then(response => {
        if (response.ok) {
          return Promise.resolve(response);
        }
        else {
          return Promise.reject(new Error('Failed to load')); 
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log(data);
        initSlides(data);
      })
      .catch(error => {
        console.error('Error:', error);
      });


  </script>

</body>
</html>
